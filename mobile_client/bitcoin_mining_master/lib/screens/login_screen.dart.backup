import 'package:flutter/material.dart';
// import 'package:google_sign_in/google_sign_in.dart'; // ÊöÇÊó∂Á¶ÅÁî®
import 'package:device_info_plus/device_info_plus.dart';
import '../constants/app_constants.dart';
import '../services/storage_service.dart';
import '../services/api_service.dart';
import '../services/user_repository.dart';
import '../services/network_service.dart';
import '../services/device_info_service.dart';
import '../services/native_device_id_service.dart';
import 'home_screen.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final StorageService _storageService = StorageService();
  final ApiService _apiService = ApiService();
  final UserRepository _userRepository = UserRepository();
  final NetworkService _networkService = NetworkService();
  // final GoogleSignIn _googleSignIn = GoogleSignIn(scopes: ['email', 'profile']); // ÊöÇÊó∂Á¶ÅÁî®
  
  final TextEditingController _referrerCodeController = TextEditingController();
  bool _isLoading = false;
  bool _showReferrerInput = false;

  @override
  void dispose() {
    _referrerCodeController.dispose();
    super.dispose();
  }

  /// GoogleÁôªÂΩïÔºàÊöÇÊó∂Á¶ÅÁî®Ôºâ
  Future<void> _handleGoogleSignIn() async {
    // Google Sign-InÂäüËÉΩÊöÇÊó∂Á¶ÅÁî®
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('GoogleÁôªÂΩïÂäüËÉΩÊöÇÊó∂Á¶ÅÁî®\nËØ∑‰ΩøÁî®Â∏∏ËßÑÈÇÆÁÆ±ÁôªÂΩï'),
          duration: Duration(seconds: 3),
        ),
      );
    }
  }
  
  /* ÂéüGoogleÁôªÂΩï‰ª£Á†ÅÂ∑≤ÂÆåÂÖ®Ê≥®ÈáäÊéâ
    // ÂÖàÊ£ÄÊü•ÁΩëÁªúËøûÊé•
    if (!await _checkNetworkConnection()) {
      return;
    }

    setState(() => _isLoading = true);
    
    try {
      // 1. GoogleÁôªÂΩï
      GoogleSignInAccount? account = await _googleSignIn.signInSilently();
      account ??= await _googleSignIn.signIn();
      
      if (account == null) {
        _showError('Google sign-in cancelled');
        return;
      }

      final GoogleSignInAuthentication auth = await account.authentication;
      final String? googleId = account.id;
      final String? email = account.email;
      final String? displayName = account.displayName;
      
      print('‚úÖ Google login success');
      print('   - Email: $email');
      print('   - ID: $googleId');
      print('   - Name: $displayName');

      // È™åËØÅemail‰∏ç‰∏∫Á©∫
      if (email == null || email.isEmpty) {
        throw Exception('Google account email is empty. Please make sure you grant email permission.');
      }

      // Êî∂ÈõÜËÆæÂ§á‰ø°ÊÅØÔºàandroid_id„ÄÅgaid„ÄÅcountryÔºâ
      print('üîç ========================================');
      print('üîç ÂºÄÂßãÊî∂ÈõÜËÆæÂ§á‰ø°ÊÅØ...');
      print('üîç ========================================');
      String? androidId;
      String? gaid;
      String? country;
      
      // Ê≠•È™§1: Ëé∑ÂèñAndroid IDÔºàÁã¨Á´ãtry-catchÔºåÂ§±Ë¥•‰∏çÂΩ±ÂìçÂÖ∂‰ªñÔºâ
      try {
        print('üì± Ê≠•È™§1: Ëé∑ÂèñAndroid IDÔºàÂéüÁîüÊñπÊ≥ïÔºâ...');
        androidId = await NativeDeviceIdService.getAndroidId();
        
        if (androidId == null || androidId.isEmpty) {
          print('‚ö†Ô∏è ÂéüÁîüÊñπÊ≥ïËøîÂõûÁ©∫ÔºåÂ∞ùËØïdevice_info_plus...');
          final deviceInfo = DeviceInfoPlugin();
          final androidInfo = await deviceInfo.androidInfo;
          
          if (androidInfo.id.isNotEmpty && androidInfo.id != 'unknown') {
            androidId = androidInfo.id;
            print('‚úÖ ‰ΩøÁî® device_info_plus Android ID: "$androidId"');
          } else if (androidInfo.fingerprint.isNotEmpty) {
            androidId = androidInfo.fingerprint;
            print('‚ö†Ô∏è ‰ΩøÁî® fingerprint ‰Ωú‰∏∫Â§áÁî®: "$androidId"');
          }
        } else {
          print('‚úÖ ÂéüÁîüÊñπÊ≥ïËé∑ÂèñÊàêÂäü Android ID: "$androidId" (ÈïøÂ∫¶: ${androidId.length})');
        }
      } catch (e) {
        print('‚ùå Android ID Ëé∑ÂèñÂ§±Ë¥•: $e');
      }
        
      // Ê≠•È™§2: Ëé∑ÂèñGAIDÂíåCountryÔºà‰∏ÄÊ¨°ÊÄßËé∑ÂèñÊâÄÊúâËÆæÂ§á‰ø°ÊÅØÔºâ
      try {
        print('üì± Ê≠•È™§2: Ëé∑ÂèñGAIDÂíåCountry...');
        final deviceInfoMap = await DeviceInfoService.getDeviceInfo();
        
        gaid = deviceInfoMap['gaid'];
        if (gaid != null && gaid.isNotEmpty) {
          print('‚úÖ GAID Ëé∑ÂèñÊàêÂäü: ${gaid.substring(0, 8)}...');
        } else {
          print('‚ö†Ô∏è GAID ‰∏∫Á©∫');
        }
        
        country = deviceInfoMap['country'];
        if (country != null && country.isNotEmpty) {
          print('‚úÖ Country Ëé∑ÂèñÊàêÂäü: $country');
        } else {
          print('‚ö†Ô∏è Country ‰∏∫Á©∫');
        }
      } catch (e) {
        print('‚ùå GAIDÂíåCountry Ëé∑ÂèñÂ§±Ë¥•: $e');
      }
      
      print('üîç ========================================');
      print('üì± ËÆæÂ§á‰ø°ÊÅØÊî∂ÈõÜÊ±áÊÄª:');
      print('   ‚úì Android ID: ${androidId ?? "Êú™Ëé∑Âèñ"}');
      print('   ‚úì GAID: ${gaid ?? "Êú™Ëé∑Âèñ"}');
      print('   ‚úì Country: ${country ?? "Êú™Ëé∑Âèñ"}');
      print('üîç ========================================');

      // 2. Ë∞ÉÁî®ÂêéÁ´ØAPIÔºöGoogleÁôªÂΩïÊàñÂàõÂª∫Êñ∞Áî®Êà∑
      print('üîç GoogleÁôªÂΩïÊàñÂàõÂª∫Êñ∞Áî®Êà∑: $email');
      print('üì§ ÂáÜÂ§áÂèëÈÄÅÂèÇÊï∞:');
      print('   - googleId: $googleId');
      print('   - googleEmail: $email');
      print('   - androidId: $androidId');
      print('   - gaid: $gaid');
      print('   - country: $country');
      
      final response = await _apiService.googleLoginOrCreate(
        googleId: googleId,
        googleEmail: email,
        googleName: displayName ?? '',
        androidId: androidId,
        gaid: gaid,
        country: country,
      );
      print('üîç GoogleÁôªÂΩï/ÂàõÂª∫ÂìçÂ∫î: $response');

      if (response['success'] == true && response['data'] != null) {
        final userId = response['data']['user_id'] ?? response['data']['userId'];
        final invitationCode = response['data']['invitation_code'] ?? response['data']['invitationCode'];
        final isNewUser = response['isNewUser'] ?? false;
        
        print('‚úÖ ${isNewUser ? "New user created successfully" : "User login successful"}: $userId');
        
        // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÂà∞Êú¨Âú∞
        await _storageService.saveUserId(userId);
        await _storageService.saveInvitationCode(invitationCode);
        await _storageService.saveGoogleSignInStatus(true);
        await _storageService.saveGoogleEmail(email);
        
        // 3. Â§ÑÁêÜÊé®Ëçê‰∫∫ÈÇÄËØ∑Á†ÅÔºàÂ¶ÇÊûúÊúâËæìÂÖ•Ôºâ
        print('üîç ÂºÄÂßãÈ™åËØÅÈÇÄËØ∑Á†Å...');
        final referrerResult = await _handleReferrerCode(userId);
        print('üîç ÈÇÄËØ∑Á†ÅÈ™åËØÅÁªìÊûú: $referrerResult');
        
        if (!referrerResult) {
          // ÈÇÄËØ∑Á†ÅÈ™åËØÅÂ§±Ë¥•ÔºåÊí§ÈîÄGoogleÁôªÂΩïÂπ∂ÈòªÊ≠¢ÁôªÂΩïÊµÅÁ®ã
          print('‚ùå ÈÇÄËØ∑Á†ÅÈ™åËØÅÂ§±Ë¥•ÔºåÊí§ÈîÄGoogleÁôªÂΩï');
          await _googleSignIn.signOut();
          return;
        }
        
        print('‚úÖ ÈÇÄËØ∑Á†ÅÈ™åËØÅÈÄöËøáÔºåËøõÂÖ•Â∫îÁî®');
        _navigateToHome();
      } else {
        // ÂàõÂª∫/ÁôªÂΩïÂ§±Ë¥• - ÁΩëÁªúÊàñÊúçÂä°Âô®ÈîôËØØ
        String errorMessage = response['message'] ?? response['error'] ?? 'Server error. Please try again later.';
        
        // Ê†áÂáÜÂåñÈîôËØØÊ∂àÊÅØ
        if (errorMessage.contains('network') || errorMessage.contains('connection')) {
          errorMessage = 'Network connection error. Please check your internet connection and try again.';
        } else if (errorMessage.contains('timeout')) {
          errorMessage = 'Connection timeout. Please try again.';
        } else if (!errorMessage.contains('Server error') && !errorMessage.contains('Network')) {
          errorMessage = 'Server error. Please try again later.';
        }
        
        print('‚ùå GoogleÁôªÂΩï/ÂàõÂª∫Â§±Ë¥•: $errorMessage');
        await _googleSignIn.signOut();
        _showError(errorMessage);
      }
    } catch (e) {
      print('‚ùå Google sign-in error: $e');
      await _googleSignIn.signOut();
      
      String errorMsg = e.toString();
      if (errorMsg.contains('network') || errorMsg.contains('connection') || errorMsg.contains('SocketException')) {
        errorMsg = 'Network connection error. Please check your internet connection and try again.';
      } else if (errorMsg.contains('timeout')) {
        errorMsg = 'Connection timeout. Please try again.';
      } else if (errorMsg.contains('Server error')) {
        errorMsg = 'Server error. Please try again later.';
      } else {
        errorMsg = 'Google sign-in failed. Please try again.';
      }
      _showError(errorMsg);
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  } // Âéü_handleGoogleSignInÂáΩÊï∞ÁªìÊùü
  */ // Ê≥®ÈáäÁªìÊùü

  /// ËÆøÂÆ¢Ê®°Âºè
  Future<void> _handleGuestMode() async {
    // ÂÖàÊ£ÄÊü•ÁΩëÁªúËøûÊé•
    if (!await _checkNetworkConnection()) {
      return;
    }

    setState(() => _isLoading = true);
    
    try {
      // Ê£ÄÊü•Êú¨Âú∞ÊòØÂê¶Â∑≤ÊúâË¥¶Âè∑ÔºàÂç≥‰ΩøÂ∑≤ÁôªÂá∫Ôºâ
      String? existingUserId = _storageService.getUserId();
      String? existingInvitationCode = _storageService.getInvitationCode();
      
      if (existingUserId != null && existingUserId.isNotEmpty && 
          !existingUserId.startsWith('OFFLINE_') &&
          existingInvitationCode != null && existingInvitationCode.isNotEmpty) {
        // ÊúâÂ∑≤Â≠òÂú®ÁöÑË¥¶Âè∑ ‚Üí ÊÅ¢Â§çË¥¶Âè∑Ôºà‰∏çÂàõÂª∫Êñ∞Ë¥¶Âè∑Ôºâ
        print('‚úÖ Ë¥¶Âè∑ÊÅ¢Â§çÊ®°Âºè: Ê£ÄÊµãÂà∞Â∑≤Â≠òÂú®Ë¥¶Âè∑ $existingUserId');
        await _storageService.saveIsLoggedOut(false);  // Ê∏ÖÈô§ÁôªÂá∫Ê†áËÆ∞
        
        // Â§ÑÁêÜÊé®Ëçê‰∫∫ÈÇÄËØ∑Á†ÅÔºàÂ¶ÇÊûúËøôÊ¨°ÁôªÂΩïÈ°µËæìÂÖ•‰∫ÜÊñ∞ÁöÑÈÇÄËØ∑Á†ÅÔºâ- Â¶ÇÊûúÈ™åËØÅÂ§±Ë¥•ÂàôÈòªÊ≠¢ÁôªÂΩï
        final referrerResult = await _handleReferrerCode(existingUserId);
        if (!referrerResult) {
          // ÈÇÄËØ∑Á†ÅÈ™åËØÅÂ§±Ë¥•Ôºå‰∏çÁªßÁª≠ÁôªÂΩïÊµÅÁ®ã
          return;
        }
        
        _navigateToHome();
      } else {
        // Ê≤°ÊúâÂ∑≤Â≠òÂú®ÁöÑË¥¶Âè∑ ‚Üí ÂàõÂª∫Êñ∞Ë¥¶Âè∑
        print('‚úÖ Êñ∞Ë¥¶Âè∑Ê®°Âºè: ÂàõÂª∫ÂÖ®Êñ∞ÁöÑÊ∏∏ÂÆ¢Ë¥¶Âè∑');
        final result = await _userRepository.fetchUserId();
        
        if (result.isSuccess) {
          // Ëé∑ÂèñuserId
          final userId = _storageService.getUserId();
          if (userId != null && userId.isNotEmpty) {
            await _storageService.saveIsLoggedOut(false);  // Ê†áËÆ∞‰∏∫Â∑≤ÁôªÂΩï
            // Â§ÑÁêÜÊé®Ëçê‰∫∫ÈÇÄËØ∑Á†ÅÔºàÂ¶ÇÊûúÊúâÔºâ- Â¶ÇÊûúÈ™åËØÅÂ§±Ë¥•ÂàôÈòªÊ≠¢ÁôªÂΩï
            final referrerResult = await _handleReferrerCode(userId);
            if (!referrerResult) {
              // ÈÇÄËØ∑Á†ÅÈ™åËØÅÂ§±Ë¥•Ôºå‰∏çÁªßÁª≠ÁôªÂΩïÊµÅÁ®ã
              return;
            }
          }
          _navigateToHome();
        } else {
          // ÁΩëÁªúÊàñÊúçÂä°Âô®ÈîôËØØÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
          String errorMsg = result.error?.toString() ?? 'Failed to create account';
          
          // Ê∏ÖÁêÜÂèØËÉΩÊÆãÁïôÁöÑÁ¶ªÁ∫øÊï∞ÊçÆ
          await _storageService.saveUserId('');
          await _storageService.saveInvitationCode('');
          await _storageService.setOfflineUser(false);
          
          print('‚ùå GuestÁôªÂΩïÂ§±Ë¥•: $errorMsg');
          _showError(errorMsg);
        }
      }
    } catch (e) {
      print('‚ùå Guest mode error: $e');
      
      // Ê∏ÖÁêÜÂèØËÉΩÊÆãÁïôÁöÑÁ¶ªÁ∫øÊï∞ÊçÆ
      await _storageService.saveUserId('');
      await _storageService.saveInvitationCode('');
      await _storageService.setOfflineUser(false);
      
      String errorMsg = e.toString();
      if (errorMsg.contains('Network connection')) {
        errorMsg = 'Network connection error. Please check your internet connection and try again.';
      } else if (errorMsg.contains('Server error')) {
        errorMsg = 'Server error. Please try again later.';
      }
      _showError(errorMsg);
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  /// Ëé∑ÂèñÊàñÂàõÂª∫Áî®Êà∑ID
  Future<String> _getOrCreateUserId() async {
    String? userId = _storageService.getUserId();
    
    if (userId == null || userId.isEmpty || userId.startsWith('OFFLINE_')) {
      final result = await _userRepository.fetchUserId();
      if (result.isSuccess && result.data != null) {
        userId = result.data!;
      } else {
        throw Exception('Failed to get user ID');
      }
    }
    
    return userId;
  }

  /// Â§ÑÁêÜÊé®Ëçê‰∫∫ÈÇÄËØ∑Á†Å
  /// Â§ÑÁêÜÈÇÄËØ∑Á†ÅÈ™åËØÅ
  /// ËøîÂõû true Ë°®Á§∫ÂèØ‰ª•ÁªßÁª≠ÁôªÂΩïÔºàÈÇÄËØ∑Á†Å‰∏∫Á©∫ÊàñÈ™åËØÅÊàêÂäüÔºâ
  /// ËøîÂõû false Ë°®Á§∫‰∏çËÉΩÁªßÁª≠ÁôªÂΩïÔºàÈÇÄËØ∑Á†ÅÈ™åËØÅÂ§±Ë¥•Ôºâ
  Future<bool> _handleReferrerCode(String userId) async {
    final referrerCode = _referrerCodeController.text.trim();
    
    print('üîç _handleReferrerCode - referrerCode: "$referrerCode"');
    
    // 1. Â¶ÇÊûúÈÇÄËØ∑Á†Å‰∏∫Á©∫ÔºåÂÖÅËÆ∏ÁªßÁª≠ÁôªÂΩï
    if (referrerCode.isEmpty) {
      print('‚úÖ ÈÇÄËØ∑Á†Å‰∏∫Á©∫ÔºåÂÖÅËÆ∏ÁôªÂΩï');
      return true;
    }

    print('üîç ÈÇÄËØ∑Á†Å‰∏ç‰∏∫Á©∫ÔºåÂºÄÂßãÈ™åËØÅ...');
    
    // 2. ÊúâÈÇÄËØ∑Á†ÅËæìÂÖ•ÔºåÂøÖÈ°ªÈ™åËØÅÊàêÂäüÊâçËÉΩÁªßÁª≠
    try {
      final response = await _apiService.addReferrer(
        userId: userId,
        referrerInvitationCode: referrerCode,
      );
      
      print('üîç APIÂìçÂ∫î: $response');
      
      if (response['success'] == true) {
        print('‚úÖ Referrer code added successfully');
        // ÂàõÂª∫ÂÖçË¥πÂπøÂëäÂêàÁ∫¶
        await _apiService.createAdFreeContract(userId: userId);
        return true;  // È™åËØÅÊàêÂäüÔºåÂÖÅËÆ∏ÁªßÁª≠ÁôªÂΩï
      } else {
        // ÈÇÄËØ∑Á†ÅÈ™åËØÅÂ§±Ë¥• - ÈòªÊ≠¢ÁôªÂΩï
        print('‚ùå ÈÇÄËØ∑Á†ÅÈ™åËØÅÂ§±Ë¥•: ${response['message']}');
        String errorMsg = response['message'] ?? 'Invalid invitation code';
        if (errorMsg.contains('not found') || 
            errorMsg.contains('not exist')) {
          errorMsg = 'The invitation code you entered does not exist. Please confirm and try again.';
        }
        _showInvitationCodeError(errorMsg);
        return false;  // È™åËØÅÂ§±Ë¥•ÔºåÈòªÊ≠¢ÁôªÂΩï
      }
    } catch (e) {
      print('‚ùå ÈÇÄËØ∑Á†ÅÈ™åËØÅÂºÇÂ∏∏: $e');
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÈÇÄËØ∑Á†Å‰∏çÂ≠òÂú®ÁöÑÈîôËØØ
      String errorMsg = e.toString();
      if (errorMsg.contains('404') || errorMsg.contains('not found') || 
          errorMsg.contains('not exist')) {
        _showInvitationCodeError('The invitation code you entered does not exist. Please confirm and try again.');
      } else {
        _showInvitationCodeError('Failed to verify invitation code. Please try again.');
      }
      return false;  // È™åËØÅÂ§±Ë¥•ÔºåÈòªÊ≠¢ÁôªÂΩï
    }
  }

  /// ÊòæÁ§∫ÈÇÄËØ∑Á†ÅÈîôËØØÊèêÁ§∫
  void _showInvitationCodeError(String message) {
    if (!mounted) return;
    
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: AppColors.cardDark,
          title: Row(
            children: [
              Icon(Icons.error_outline, color: Colors.orangeAccent, size: 24),
              const SizedBox(width: 8),
              const Text(
                'Invalid Invitation Code',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: Colors.orangeAccent,
                ),
              ),
            ],
          ),
          content: Text(
            message,
            style: const TextStyle(
              color: AppColors.textPrimary,
              fontSize: 14,
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text(
                'OK',
                style: TextStyle(color: AppColors.primary),
              ),
            ),
          ],
        );
      },
    );
  }

  /// ÂØºËà™Âà∞‰∏ªÈ°µ
  void _navigateToHome() {
    if (!mounted) return;
    
    Navigator.of(context).pushReplacement(
      MaterialPageRoute(builder: (context) => const HomeScreen()),
    );
  }

  /// ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
  void _showError(String message) {
    if (!mounted) return;
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  /// Ê£ÄÊü•ÁΩëÁªúËøûÊé•
  Future<bool> _checkNetworkConnection() async {
    final isConnected = await _networkService.isConnected();
    
    if (!isConnected) {
      _showNetworkError();
      return false;
    }

    // Ê£ÄÊü•ÊòØÂê¶ËÉΩËøûÊé•Âà∞ÂêéÁ´Ø
    final canReach = await _networkService.canReachBackend();
    if (!canReach) {
      _showNetworkError();
      return false;
    }

    return true;
  }

  /// ÊòæÁ§∫ÁΩëÁªúÈîôËØØÊèêÁ§∫
  void _showNetworkError() {
    if (!mounted) return;
    
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: AppColors.cardDark,
          title: const Text(
            'Network Connection Error',
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
              color: Colors.redAccent,
            ),
          ),
          content: const Text('Please check your network and try again!'),
          actions: [
            TextButton(
              onPressed: () {
                Navigator.of(context).pop();
              },
              child: Text(
                'OK',
                style: TextStyle(
                  color: AppColors.primary,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Container(
        width: double.infinity,
        height: double.infinity,
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1a1a1a),  // Ê∑±ÁÅ∞Ëâ≤
              Color(0xFF2d2d2d),  // ‰∏≠ÁÅ∞Ëâ≤
              Color(0xFF3d3d3d),  // ÊµÖÁÅ∞Ëâ≤
              Color(0xFFFF9500),  // Ê©ôÈªÑËâ≤
            ],
            stops: [0.0, 0.4, 0.7, 1.0],
          ),
        ),
        child: SafeArea(
          child: _isLoading
              ? const Center(child: CircularProgressIndicator())
              : SingleChildScrollView(
                  padding: const EdgeInsets.all(24.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      const SizedBox(height: 40),
                      
                      // Logo
                      Center(
                        child: Container(
                          width: 100,
                          height: 100,
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(20),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.2),
                                blurRadius: 8,
                                offset: const Offset(0, 4),
                              ),
                            ],
                          ),
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(20),
                            child: Image.asset(
                              'assets/images/bitcoin_chip_logo.png',
                              fit: BoxFit.cover,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      
                      // Title
                      const Text(
                        'Bitcoin Mining Master',
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 28,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Start Your Mining Journey',
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 16,
                          color: AppColors.textSecondary,
                        ),
                      ),
                      
                      const SizedBox(height: 60),
                      
                      // Referrer Code Section
                      _buildReferrerCodeSection(),
                      
                      const SizedBox(height: 40),
                      
                      // Google Sign In Button
                      _buildGoogleSignInButton(),
                      
                      const SizedBox(height: 16),
                      
                      // Continue as Guest
                      _buildGuestButton(),
                      
                      const SizedBox(height: 24),
                      
                      // Terms & Privacy
                      _buildTermsText(),
                    ],
                  ),
                ),
        ),
      ),
    );
  }

  Widget _buildGoogleSignInButton() {
    return ElevatedButton(
      onPressed: _handleGoogleSignIn,
      style: ElevatedButton.styleFrom(
        backgroundColor: Colors.white,
        foregroundColor: Colors.black87,
        padding: const EdgeInsets.symmetric(vertical: 16),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        elevation: 2,
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Image.asset(
            'assets/images/google.png',
            width: 24,
            height: 24,
          ),
          const SizedBox(width: 12),
          const Text(
            'Sign In With Google (Recommended)',
            style: TextStyle(
              fontSize: 15,
              fontWeight: FontWeight.w600,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildReferrerCodeSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        // Ê†áÈ¢ò
        Padding(
          padding: const EdgeInsets.only(bottom: 12),
          child: Text(
            'Referrer\'s Invitation Code (Optional)',
            style: TextStyle(
              color: Colors.white,
              fontSize: 15,
              fontWeight: FontWeight.w600,
            ),
            textAlign: TextAlign.center,
          ),
        ),
        // ËæìÂÖ•Ê°Ü
        Container(
          decoration: BoxDecoration(
            boxShadow: [
              BoxShadow(
                color: AppColors.primary.withOpacity(0.2),
                blurRadius: 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: TextField(
            controller: _referrerCodeController,
            decoration: InputDecoration(
              hintText: 'INV...',
              hintStyle: TextStyle(
                color: AppColors.textSecondary.withOpacity(0.6),
                fontSize: 14,
              ),
              filled: true,
              fillColor: Colors.white,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(
                  color: AppColors.primary,
                  width: 2,
                ),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(
                  color: AppColors.primary.withOpacity(0.5),
                  width: 2,
                ),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(
                  color: AppColors.primary,
                  width: 2,
                ),
              ),
              prefixIcon: Icon(
                Icons.card_giftcard,
                color: AppColors.primary,
                size: 24,
              ),
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 18,
              ),
            ),
            textCapitalization: TextCapitalization.characters,
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w600,
              color: Colors.black87,
              letterSpacing: 1,
            ),
          ),
        ),
        const SizedBox(height: 12),
        // ÊèêÁ§∫‰ø°ÊÅØ
        Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: AppColors.primary.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(
              color: AppColors.primary.withOpacity(0.3),
            ),
          ),
          child: Row(
            children: [
              Icon(
                Icons.info_outline,
                color: AppColors.primary,
                size: 18,
              ),
              const SizedBox(width: 8),
              Expanded(
                child: Text(
                  'Enter your referrer\'s invitation code to get extra reward! If you have already bound it, please ignore this.',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 13,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildGuestButton() {
    return OutlinedButton(
      onPressed: _handleGuestMode,
      style: OutlinedButton.styleFrom(
        foregroundColor: Colors.white,
        side: BorderSide(
          color: Color(0xFF06B6D4),  // Êòé‰∫ÆÁöÑÈùíËìùËâ≤ËæπÊ°Ü
          width: 2,
        ),
        padding: const EdgeInsets.symmetric(vertical: 16),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
      ),
      child: Text(
        'Continue As Guest',
        style: TextStyle(
          fontSize: 16,
          fontWeight: FontWeight.w600,
          color: Colors.white,
        ),
      ),
    );
  }

  Widget _buildTermsText() {
    return Text(
      'By continuing, you agree to our Terms of Service and Privacy Policy',
      textAlign: TextAlign.center,
      style: TextStyle(
        fontSize: 12,
        color: AppColors.textSecondary.withOpacity(0.7),
      ),
    );
  }
}
