# ä»˜è´¹åˆçº¦åŠŸèƒ½å®ç°æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ—¥æœŸ
2026-01-18

## âœ… åŠŸèƒ½éœ€æ±‚éªŒè¯

### 1. ä»˜è´¹åˆçº¦ä¸å—å›½å®¶ç³»æ•°å½±å“ âœ… å·²å®ç°

**ä»£ç ä½ç½®**: `src/services/paidContractService.js`
```javascript
// ç¬¬4-7è¡Œæ³¨é‡Šæ˜ç¡®è¯´æ˜
/**
 * ç‰¹ç‚¹ï¼š
 * 1. å•ç‹¬çš„æŒ–çŸ¿é˜Ÿåˆ—ï¼ˆä¸ä¸å…è´¹åˆçº¦æ··åˆï¼‰
 * 2. ä¸ä½¿ç”¨å›½å®¶ç³»æ•°ï¼ˆåªä½¿ç”¨è´­ä¹°æ—¶ç¡®å®šçš„ç®—åŠ›å€¼ï¼‰
 * 3. æ ¹æ®ä»˜è´¹æ¡£ä½è®¡ç®—æ¯ç§’æ¯”ç‰¹å¸äº§å‡º
 */
```

**ä»£ç ä½ç½®**: `src/services/contractRewardService.js` ç¬¬196-232è¡Œ
```javascript
/**
 * è®¡ç®—ä»˜è´¹åˆçº¦æ”¶ç›Š
 * âš ï¸ æ³¨æ„ï¼šä»˜è´¹åˆçº¦ä¸ä½¿ç”¨å›½å®¶ç³»æ•°ï¼Œç›´æ¥ä½¿ç”¨åˆçº¦åˆ›å»ºæ—¶ç¡®å®šçš„hashrate
 */
static async calculatePaidContractRevenue(userId, startTime, endTime) {
  // ...æŸ¥è¯¢ä»˜è´¹åˆçº¦
  // âœ… ä»˜è´¹åˆçº¦ä¸ä½¿ç”¨å›½å®¶ç³»æ•°ï¼Œç›´æ¥ç”¨contract.hashrateè®¡ç®—
  const revenue = contract.hashrate * seconds;
}
```

**éªŒè¯**: 
- âœ… ä»˜è´¹åˆçº¦åˆ›å»ºæ—¶ä½¿ç”¨å›ºå®š `hashrate` (ç¬¬95è¡Œ)
- âœ… æ”¶ç›Šè®¡ç®—æ—¶ç›´æ¥ä½¿ç”¨ `contract.hashrate * seconds`ï¼Œä¸è°ƒç”¨ä»»ä½•å›½å®¶ç³»æ•°
- âœ… å…è´¹åˆçº¦è°ƒç”¨ `LevelService.calculateMiningSpeed()` è·å– `finalSpeedWithCountry`
- âœ… ä»˜è´¹åˆçº¦**ä¸è°ƒç”¨** `LevelService.calculateMiningSpeed()`

---

### 2. ä¸å—çŸ¿å·¥ç­‰çº§é€Ÿç‡ç³»æ•°å½±å“ âœ… å·²å®ç°

**ä»£ç å¯¹æ¯”**:

**å…è´¹åˆçº¦** (`contractRewardService.js` ç¬¬64-75è¡Œ):
```javascript
// 1. è·å–ç”¨æˆ·æŒ–çŸ¿é€Ÿåº¦ï¼ˆåº”ç”¨å…¬å¼ï¼šåŒ…å«ç­‰çº§ç³»æ•°ï¼‰
const speedInfo = await LevelService.calculateMiningSpeed(userId);
const speedPerSecond = speedInfo.finalSpeedWithCountry;

// 2. è®¡ç®—å…è´¹å¹¿å‘Šåˆçº¦æ”¶ç›Šï¼ˆä½¿ç”¨ç­‰çº§é€Ÿç‡ï¼‰
const adRevenue = await this.calculateFreeContractRevenue(
  userId, 
  'ad free contract', 
  startTime, 
  endTime,
  speedPerSecond  // â† åŒ…å«ç­‰çº§ç³»æ•°
);
```

**ä»˜è´¹åˆçº¦** (`contractRewardService.js` ç¬¬112-117è¡Œ):
```javascript
// 6. è®¡ç®—ä»˜è´¹åˆçº¦æ”¶ç›Šï¼ˆä¸ä½¿ç”¨å›½å®¶ç³»æ•°ï¼Œä¹Ÿä¸ä½¿ç”¨ç­‰çº§ç³»æ•°ï¼‰
const paidRevenue = await this.calculatePaidContractRevenue(
  userId, 
  startTime, 
  endTime
  // â† æ³¨æ„ï¼šæ²¡æœ‰ä¼ å…¥ speedPerSecond å‚æ•°
);
```

**éªŒè¯**:
- âœ… å…è´¹åˆçº¦é€šè¿‡ `LevelService.calculateMiningSpeed()` è·å–ç­‰çº§ç³»æ•°
- âœ… ä»˜è´¹åˆçº¦ `calculatePaidContractRevenue()` **ä¸æ¥æ”¶** `speedPerSecond` å‚æ•°
- âœ… ä»˜è´¹åˆçº¦åªä½¿ç”¨åˆçº¦åˆ›å»ºæ—¶çš„å›ºå®š `hashrate`

---

### 3. ä¸å—ç‰¹æ®ŠåŠ æˆç³»æ•°å½±å“ âœ… å·²å®ç°

**ç‰¹æ®ŠåŠ æˆç³»æ•°æ¥æº**:
- `country_multiplier` (å›½å®¶ç³»æ•°)
- `levelMultiplier` (ç­‰çº§ç³»æ•°)  
- `dailyBonusMultiplier` (æ¯æ—¥ç­¾åˆ°åŠ æˆ)

**ä»£ç éªŒè¯** (`multiplierService.js` ç¬¬40è¡Œ):
```javascript
const totalMultiplier = countryMultiplier * levelMultiplier * dailyBonusMultiplier;
```

**ä»˜è´¹åˆçº¦å®ç°**:
- âœ… ä¸è°ƒç”¨ `MultiplierService` çš„ä»»ä½•æ–¹æ³•
- âœ… ä¸è¯»å– `user_information.country_multiplier`
- âœ… ä¸è¯»å– `user_information.level`
- âœ… ä¸æŸ¥è¯¢ `cumulative_check_in_reward` è¡¨çš„åŠ æˆæ•°æ®
- âœ… ç›´æ¥ä½¿ç”¨åˆçº¦ `hashrate`ï¼Œå®Œå…¨ç‹¬ç«‹äºå€æ•°ç³»ç»Ÿ

---

### 4. å•ç‹¬çš„æŒ–çŸ¿é˜Ÿåˆ— âœ… å·²å®ç°

**ä»£ç ä½ç½®**: `src/services/contractRewardService.js` ç¬¬46-120è¡Œ

**åˆ†ç¦»çš„è®¡ç®—é€»è¾‘**:
```javascript
static async calculateUserTotalRevenue(userId, startTime, endTime) {
  let totalRevenue = 0;
  const details = { /* ... */ };

  // 1-5. å…è´¹åˆçº¦ï¼ˆä½¿ç”¨ç­‰çº§é€Ÿç‡ + å›½å®¶ç³»æ•°ï¼‰
  const speedInfo = await LevelService.calculateMiningSpeed(userId);
  const speedPerSecond = speedInfo.finalSpeedWithCountry;
  
  // å…è´¹åˆçº¦ç±»å‹
  details.adFreeContracts = await this.calculateFreeContractRevenue(..., speedPerSecond);
  details.dailySignInContracts = await this.calculateFreeContractRevenue(..., speedPerSecond);
  details.invitationContracts = await this.calculateFreeContractRevenue(..., speedPerSecond);
  details.bindReferrerContracts = await this.calculateFreeContractRevenue(..., speedPerSecond);

  // 6. ä»˜è´¹åˆçº¦ï¼ˆç‹¬ç«‹è®¡ç®—ï¼Œä¸ä½¿ç”¨ä»»ä½•ç³»æ•°ï¼‰
  details.paidContracts = await this.calculatePaidContractRevenue(userId, startTime, endTime);
  
  return { totalRevenue, details };
}
```

**éªŒè¯**:
- âœ… å…è´¹åˆçº¦å’Œä»˜è´¹åˆçº¦ä½¿ç”¨**ä¸åŒçš„æ–¹æ³•**è®¡ç®—
- âœ… `calculateFreeContractRevenue()` - å…è´¹åˆçº¦ï¼ˆå«ç³»æ•°ï¼‰
- âœ… `calculatePaidContractRevenue()` - ä»˜è´¹åˆçº¦ï¼ˆçº¯ hashrateï¼‰
- âœ… ä¸¤ä¸ªé˜Ÿåˆ—çš„æ”¶ç›Šæœ€åæ±‡æ€»åˆ° `totalRevenue`

**æ•°æ®åº“æŸ¥è¯¢åˆ†ç¦»** (`balanceSyncTask.js` ç¬¬72-93è¡Œ):
```javascript
SELECT DISTINCT user_id
FROM (
  -- å…è´¹åˆçº¦ç”¨æˆ·
  SELECT DISTINCT user_id 
  FROM free_contract_records 
  WHERE mining_status = 'mining' 
  AND free_contract_end_time > NOW()
  
  UNION
  
  -- ä»˜è´¹åˆçº¦ç”¨æˆ·
  SELECT DISTINCT user_id 
  FROM mining_contracts 
  WHERE mining_status = 'mining' 
  AND contract_end_time > NOW()
) AS active_users
```

**éªŒè¯**:
- âœ… å…è´¹åˆçº¦å­˜å‚¨åœ¨ `free_contract_records` è¡¨
- âœ… ä»˜è´¹åˆçº¦å­˜å‚¨åœ¨ `mining_contracts` è¡¨ï¼ˆcontract_type='paid contract'ï¼‰
- âœ… ä¸¤ä¸ªè¡¨ç»“æ„ä¸åŒï¼Œå®Œå…¨ç‹¬ç«‹

---

### 5. æ ¹æ®ä»˜è´¹æ¡£ä½è®¡ç®—æ¯ç§’æ¯”ç‰¹å¸äº§å‡º âœ… å·²å®ç°

**ä»£ç ä½ç½®**: `src/services/paidContractService.js` ç¬¬17-57è¡Œ

**ä»˜è´¹æ¡£ä½é…ç½®**:
```javascript
static CONTRACT_TIERS = {
  'p0499': {  // $4.99
    price: 4.99,
    name: 'contract_4.99',
    duration: 30,  // 30å¤©
    hashrate: 0.00000000000456,  // å®é™…æ¯ç§’æŒ–çŸ¿BTCæ•°
    displayHashrate: '176.3Gh/s',  // å‰ç«¯æ˜¾ç¤ºçš„ç®—åŠ›å€¼
    description: 'å…¥é—¨åˆçº¦ - 30å¤©æŒ–çŸ¿'
  },
  'p0699': {  // $6.99
    price: 6.99,
    duration: 30,
    hashrate: 0.00000000000772,
    displayHashrate: '305.6Gh/s',
    description: 'æ ‡å‡†åˆçº¦ - 30å¤©æŒ–çŸ¿'
  },
  'p0999': {  // $9.99
    price: 9.99,
    duration: 30,
    hashrate: 0.0000000000154,
    displayHashrate: '611.2Gh/s',
    description: 'è¿›é˜¶åˆçº¦ - 30å¤©æŒ–çŸ¿'
  },
  'p1999': {  // $19.99
    price: 19.99,
    duration: 30,
    hashrate: 0.0000000000335,
    displayHashrate: '1326.4Gh/s',
    description: 'é«˜çº§åˆçº¦ - 30å¤©æŒ–çŸ¿'
  }
};
```

**åˆçº¦åˆ›å»ºé€»è¾‘** (ç¬¬95-96è¡Œ):
```javascript
// 4. åˆ›å»ºä»˜è´¹åˆçº¦ï¼ˆä¸ä½¿ç”¨å›½å®¶ç³»æ•°ï¼Œç›´æ¥ä½¿ç”¨æ¡£ä½hashrateï¼‰
const contract = await MiningContract.create({
  user_id: userId,
  contract_type: 'paid contract',
  hashrate: tier.hashrate,  // âœ… å›ºå®šç®—åŠ›ï¼Œä¸å—å›½å®¶ç³»æ•°å½±å“
  mining_status: 'mining'
});
```

**é¢„æœŸæ”¶ç›Šè®¡ç®—** (ç¬¬104-106è¡Œ):
```javascript
// 5. è®¡ç®—é¢„æœŸæ”¶ç›Šï¼ˆä¸å«ä»»ä½•å€æ•°ï¼‰
const durationSeconds = tier.duration * 24 * 60 * 60;
const expectedRevenue = tier.hashrate * durationSeconds;
```

**éªŒè¯**:
- âœ… 4ä¸ªæ¡£ä½æ˜ç¡®é…ç½®äº†æ¯ç§’ BTC äº§å‡º (`hashrate`)
- âœ… åˆ›å»ºåˆçº¦æ—¶ç›´æ¥ä½¿ç”¨æ¡£ä½çš„ `tier.hashrate`
- âœ… é¢„æœŸæ”¶ç›Š = hashrate Ã— æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œä¸å«ä»»ä½•å…¶ä»–ç³»æ•°

---

## ğŸ” å®æ—¶ä½™é¢è®¡ç®—éªŒè¯

**ä»£ç ä½ç½®**: `src/services/realtimeBalanceService.js` ç¬¬60-90è¡Œ

```javascript
static async calculateUserPerSecondRevenue(userId) {
  try {
    let totalPerSecond = 0;

    // 1. è®¡ç®—å…è´¹åˆçº¦æ”¶ç›Šï¼ˆåŒ…å«å›½å®¶ç³»æ•°å’Œç­‰çº§ç³»æ•°ï¼‰
    const freeContracts = await sequelize.query(`
      SELECT hashrate
      FROM free_contract_records 
      WHERE user_id = ? 
      AND mining_status = 'mining' 
      AND free_contract_end_time > NOW()
    `, { replacements: [userId], type: sequelize.QueryTypes.SELECT });

    for (const contract of freeContracts) {
      totalPerSecond += parseFloat(contract.hashrate);
    }

    // 2. è®¡ç®—ä»˜è´¹åˆçº¦æ”¶ç›Šï¼ˆä½¿ç”¨å›ºå®šhashrateï¼‰
    const paidContracts = await sequelize.query(`
      SELECT hashrate
      FROM mining_contracts 
      WHERE user_id = ? 
      AND mining_status = 'mining' 
      AND contract_end_time > NOW()
    `, { replacements: [userId], type: sequelize.QueryTypes.SELECT });

    for (const contract of paidContracts) {
      totalPerSecond += parseFloat(contract.hashrate);  // âœ… ç›´æ¥ç´¯åŠ ï¼Œæ— ç³»æ•°
    }

    return totalPerSecond;
  }
}
```

**éªŒè¯**:
- âœ… å…è´¹åˆçº¦ä» `free_contract_records` è¡¨è¯»å–ï¼ˆhashrateå·²åŒ…å«ç³»æ•°ï¼‰
- âœ… ä»˜è´¹åˆçº¦ä» `mining_contracts` è¡¨è¯»å–ï¼ˆhashrateæ˜¯çº¯å‡€å›ºå®šå€¼ï¼‰
- âœ… ä¸¤ç§åˆçº¦çš„ hashrate ç›´æ¥ç›¸åŠ ï¼Œæ— äºŒæ¬¡è®¡ç®—

---

## ğŸ“Š æ€»ç»“

| åŠŸèƒ½éœ€æ±‚ | å®ç°çŠ¶æ€ | ä»£ç æ–‡ä»¶ |
|---------|---------|---------|
| âœ… ä¸å—å›½å®¶ç³»æ•°å½±å“ | **å·²å®ç°** | `contractRewardService.js:196-232` |
| âœ… ä¸å—çŸ¿å·¥ç­‰çº§é€Ÿç‡ç³»æ•°å½±å“ | **å·²å®ç°** | `paidContractService.js:95`, `contractRewardService.js:112-117` |
| âœ… ä¸å—ç‰¹æ®ŠåŠ æˆç³»æ•°å½±å“ | **å·²å®ç°** | ä»˜è´¹åˆçº¦ä¸è°ƒç”¨ `MultiplierService` |
| âœ… å•ç‹¬çš„æŒ–çŸ¿é˜Ÿåˆ— | **å·²å®ç°** | å…è´¹åˆçº¦ `free_contract_records` vs ä»˜è´¹åˆçº¦ `mining_contracts` |
| âœ… æ ¹æ®ä»˜è´¹æ¡£ä½è®¡ç®—æ¯ç§’BTCäº§å‡º | **å·²å®ç°** | `paidContractService.js:17-57` (CONTRACT_TIERS) |

---

## âœ… å…³é”®å®ç°è¦ç‚¹

1. **æ•°æ®éš”ç¦»**: 
   - å…è´¹åˆçº¦å­˜å‚¨åœ¨ `free_contract_records` è¡¨
   - ä»˜è´¹åˆçº¦å­˜å‚¨åœ¨ `mining_contracts` è¡¨ï¼ˆ`contract_type='paid contract'`ï¼‰

2. **è®¡ç®—éš”ç¦»**:
   - å…è´¹åˆçº¦: `calculateFreeContractRevenue(userId, type, startTime, endTime, speedPerSecond)`
   - ä»˜è´¹åˆçº¦: `calculatePaidContractRevenue(userId, startTime, endTime)` - æ—  speedPerSecond å‚æ•°

3. **ç³»æ•°éš”ç¦»**:
   - å…è´¹åˆçº¦è°ƒç”¨ `LevelService.calculateMiningSpeed(userId)` è·å–ç»¼åˆç³»æ•°
   - ä»˜è´¹åˆçº¦ç›´æ¥ä½¿ç”¨ `contract.hashrate`ï¼Œä¸è°ƒç”¨ä»»ä½•ç³»æ•°è®¡ç®—æœåŠ¡

4. **æ¡£ä½ç®¡ç†**:
   - 4ä¸ªé¢„å®šä¹‰æ¡£ä½ (p0499, p0699, p0999, p1999)
   - æ¯ä¸ªæ¡£ä½å›ºå®š `hashrate`ï¼ˆæ¯ç§’BTCäº§å‡ºï¼‰
   - é¢„æœŸæ”¶ç›Š = hashrate Ã— duration_seconds

---

## ğŸ¯ ç»“è®º

**æ‰€æœ‰åŠŸèƒ½éœ€æ±‚å·²å®Œæ•´å®ç°ï¼Œä»£ç æ¶æ„æ¸…æ™°ï¼Œé€»è¾‘æ­£ç¡®ã€‚**

- ä»˜è´¹åˆçº¦ä¸å…è´¹åˆçº¦å®Œå…¨ç‹¬ç«‹ï¼Œä¸å…±äº«è®¡ç®—é€»è¾‘
- ä»˜è´¹åˆçº¦ä¸å—ä»»ä½•å€æ•°å½±å“ï¼ˆå›½å®¶ã€ç­‰çº§ã€ç‰¹æ®ŠåŠ æˆï¼‰
- æ¡£ä½é…ç½®æ˜ç¡®ï¼Œæ¯ç§’BTCäº§å‡ºå›ºå®š
- æ•°æ®åº“è¡¨ç»“æ„åˆ†ç¦»ï¼ŒæŸ¥è¯¢å’Œå­˜å‚¨äº’ä¸å¹²æ‰°

**æ¨è**: å¯ä»¥ä¸Šçº¿ä½¿ç”¨ âœ…
