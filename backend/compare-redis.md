# Redis æ–‡ä»¶å¯¹æ¯”åˆ†æ

## æ–‡ä»¶æ¦‚å†µ

### redis.js (å½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬)
- **ä½ç½®**: `backend/src/config/redis.js`
- **ç‰¹ç‚¹**: âœ… å…·æœ‰é™çº§æ¨¡å¼æ”¯æŒ
- **çŠ¶æ€**: æ­£åœ¨è¢« `src/index.js` ä½¿ç”¨

### redis-new.js (å¤‡ä»½ç‰ˆæœ¬)
- **ä½ç½®**: `backend/src/config/redis-new.js`
- **ç‰¹ç‚¹**: âŒ æ²¡æœ‰é™çº§æ¨¡å¼
- **çŠ¶æ€**: æœªä½¿ç”¨

## å…³é”®å·®å¼‚å¯¹æ¯”

| åŠŸèƒ½ | redis.js | redis-new.js |
|------|----------|--------------|
| **é™çº§æ¨¡å¼** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **é‡è¯•ç­–ç•¥** | 5æ¬¡ååœæ­¢,ç³»ç»Ÿç»§ç»­è¿è¡Œ | æ— é™é‡è¯• |
| **é”™è¯¯å¤„ç†** | æ‰€æœ‰æ–¹æ³•éƒ½æœ‰ try-catch | éƒ¨åˆ†æ–¹æ³•æœ‰ |
| **äº‹ä»¶ç›‘å¬** | 6ä¸ªäº‹ä»¶(å« end/reconnecting) | 3ä¸ªäº‹ä»¶ |
| **ç¦»çº¿é˜Ÿåˆ—** | ç¦ç”¨ (é˜²æ­¢å‘½ä»¤å †ç§¯) | é»˜è®¤å¯ç”¨ |
| `lazyConnect` | âœ… å¯ç”¨ | âŒ æœªå¯ç”¨ |
| **æ–¹æ³•ä¿æŠ¤** | æ‰€æœ‰æ–¹æ³•æ£€æŸ¥ `isReady()` | æ— æ£€æŸ¥ |
| **å¤±è´¥æ—¶è¡Œä¸º** | è¿”å›å®‰å…¨é»˜è®¤å€¼ | æŠ›å‡ºé”™è¯¯ |

## è¯¦ç»†å¯¹æ¯”

### 1. è¿æ¥é…ç½®

**redis.js (æ¨è):**
```javascript
{
  lazyConnect: true,              // å»¶è¿Ÿè¿æ¥,å…ˆæ³¨å†Œäº‹ä»¶
  retryStrategy: (times) => {
    if (times > 5) {
      console.log('ç³»ç»Ÿå°†ä»¥é™çº§æ¨¡å¼è¿è¡Œ');
      return null;                // åœæ­¢é‡è¯•
    }
    return Math.min(times * 1000, 5000);
  },
  maxRetriesPerRequest: null,     // æ— è¯·æ±‚é™åˆ¶
  enableOfflineQueue: false,      // ç¦ç”¨ç¦»çº¿é˜Ÿåˆ—
  connectTimeout: 10000
}
```

**redis-new.js:**
```javascript
{
  retryStrategy: (times) => {
    return Math.min(times * 50, 2000);  // æ— é™é‡è¯•
  },
  maxRetriesPerRequest: 3
}
```

### 2. æ–¹æ³•é”™è¯¯å¤„ç†

**redis.js (æ¨è):**
```javascript
async cacheUserLevel(...) {
  if (!this.isReady()) {
    console.warn('âš ï¸ Redis ä¸å¯ç”¨,è·³è¿‡ç¼“å­˜æ“ä½œ');
    return false;  // å®‰å…¨è¿”å›
  }
  try {
    // å®é™…æ“ä½œ
  } catch (error) {
    console.error('ç¼“å­˜å¤±è´¥:', error.message);
    return false;
  }
}
```

**redis-new.js:**
```javascript
async cacheUserLevel(...) {
  // ç›´æ¥æ‰§è¡Œ,æ— ä¿æŠ¤
  await this.client.hmset(key, data);
  // Redis ä¸å¯ç”¨æ—¶ä¼šæŠ›å‡ºé”™è¯¯å¯¼è‡´åº”ç”¨å´©æºƒ
}
```

### 3. äº‹ä»¶ç›‘å¬

**redis.js (6ä¸ªäº‹ä»¶):**
- âœ… connect
- âœ… ready
- âœ… error
- âœ… close
- âœ… reconnecting
- âœ… end

**redis-new.js (3ä¸ªäº‹ä»¶):**
- âœ… connect
- âœ… error
- âœ… close

## æ¨èæ–¹æ¡ˆ

### âœ… ä¿ç•™ redis.js (å½“å‰ç‰ˆæœ¬)

**ç†ç”±:**

1. **é«˜å¯ç”¨æ€§**: Redis æ•…éšœæ—¶ç³»ç»Ÿç»§ç»­è¿è¡Œ(é™çº§æ¨¡å¼)
2. **é”™è¯¯å¤„ç†å®Œå–„**: æ‰€æœ‰æ–¹æ³•éƒ½æœ‰ä¿æŠ¤æªæ–½
3. **æ›´å¥½çš„ç›‘æ§**: 6ä¸ªäº‹ä»¶ç›‘å¬,å®Œæ•´çš„çŠ¶æ€è¿½è¸ª
4. **ç”Ÿäº§ç¯å¢ƒå‹å¥½**: 
   - ä¸ä¼šå›  Redis æ•…éšœå¯¼è‡´æ•´ä¸ªåº”ç”¨å´©æºƒ
   - è‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
   - è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

5. **å½“å‰æµ‹è¯•ç»“æœ**: 
   - âœ… äº‘ç«¯ Redis è¿æ¥æˆåŠŸ
   - âœ… æ‰€æœ‰æ“ä½œæ­£å¸¸
   - âœ… ç‰ˆæœ¬ 7.4.6

### ğŸ—‘ï¸ å¯ä»¥åˆ é™¤ redis-new.js

**åŸå› :**
- åŠŸèƒ½ä¸å¦‚ redis.js å®Œå–„
- ç¼ºå°‘é™çº§æ¨¡å¼æ”¯æŒ
- æœªè¢«é¡¹ç›®ä½¿ç”¨
- ä¿ç•™ä¼šé€ æˆæ··æ·†

## å½“å‰è¿æ¥çŠ¶æ€

```
ä¸»æœº: 47.79.232.189
ç«¯å£: 6379
å¯†ç : å·²é…ç½® âœ…
ç‰ˆæœ¬: Redis 7.4.6
çŠ¶æ€: è¿æ¥æˆåŠŸ âœ…
```

## æµ‹è¯•ç»“æœ

âœ… PING æµ‹è¯•: æˆåŠŸ
âœ… SET æµ‹è¯•: æˆåŠŸ
âœ… GET æµ‹è¯•: æˆåŠŸ
âœ… DEL æµ‹è¯•: æˆåŠŸ
âœ… ç‰ˆæœ¬æ£€æµ‹: 7.4.6

## å»ºè®®æ“ä½œ

1. âœ… **ä¿ç•™** `backend/src/config/redis.js` (å½“å‰ä½¿ç”¨)
2. ğŸ—‘ï¸ **åˆ é™¤** `backend/src/config/redis-new.js` (æœªä½¿ç”¨çš„å¤‡ä»½)
3. âœ… **ä¿æŒ** å½“å‰ `.env` é…ç½®ä¸å˜
4. âœ… **éªŒè¯** PM2 æœåŠ¡è¿æ¥æ­£å¸¸

## ä¼˜åŒ–å»ºè®® (å¯é€‰)

å¦‚æœéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–,å¯ä»¥æ·»åŠ :

1. **è¿æ¥æ± é…ç½®**:
   ```javascript
   maxRetriesPerRequest: null,
   enableReadyCheck: true,
   enableOfflineQueue: false
   ```

2. **é”®å‰ç¼€** (å·²åœ¨ .env é…ç½®):
   ```javascript
   keyPrefix: process.env.REDIS_KEY_PREFIX || 'bmm:'
   ```

3. **æ…¢æŸ¥è¯¢æ—¥å¿—**:
   ```javascript
   showFriendlyErrorStack: process.env.NODE_ENV === 'development'
   ```

