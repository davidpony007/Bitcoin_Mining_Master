# 本地环境配置修复说明

## 问题诊断

✅ **已解决的问题:**
1. ✅ 环境变量命名不一致（`DB_PASSWORD` vs `DB_PASS`）
2. ✅ 测试文件已更新支持两种命名方式
3. ✅ .env 文件已更新为本地配置

⚠️ **当前问题:**
- MySQL 9.5.0 版本不支持 `mysql_native_password` 认证插件
- 需要使用 `caching_sha2_password` 认证方式创建用户

## 当前配置状态

### .env 文件配置（已更新）
```bash
# 数据库配置 - 本地 MySQL
DB_HOST=127.0.0.1
DB_USER=bitcoin_mining_master
DB_PASS=FzFbWmwMptnN3ABE
DB_NAME=bitcoin_mining_master
DB_PORT=3306

# Redis 配置 - 本地 Redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=3hu8fds3y
```

### 修复的文件
1. ✅ `.env` - 更新为本地配置
2. ✅ `test_mysql_only.js` - 支持 DB_PASS 和 DB_PASSWORD
3. ✅ `test_db_connection.js` - 支持 DB_PASS 和 DB_PASSWORD

## 解决方案

### 方案一：配置 MySQL 9.x 用户（推荐）

运行配置脚本：
```bash
cd "/Users/davidpony/Desktop/Bitcoin Mining Master/backend"
./setup-mysql9-complete.sh
```

这个脚本会：
1. 创建使用 `caching_sha2_password` 的用户
2. 创建数据库
3. 导入所有表结构
4. 验证连接

### 方案二：手动配置

#### 1. 使用 root 账户登录 MySQL
```bash
mysql -u root -p
```

#### 2. 执行以下 SQL
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS bitcoin_mining_master 
  DEFAULT CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

-- 创建用户（使用 MySQL 9.x 兼容的认证）
CREATE USER 'bitcoin_mining_master'@'localhost' 
  IDENTIFIED WITH caching_sha2_password BY 'FzFbWmwMptnN3ABE';

CREATE USER 'bitcoin_mining_master'@'127.0.0.1' 
  IDENTIFIED WITH caching_sha2_password BY 'FzFbWmwMptnN3ABE';

-- 授权
GRANT ALL PRIVILEGES ON bitcoin_mining_master.* TO 'bitcoin_mining_master'@'localhost';
GRANT ALL PRIVILEGES ON bitcoin_mining_master.* TO 'bitcoin_mining_master'@'127.0.0.1';

FLUSH PRIVILEGES;
```

#### 3. 导入数据库结构
```bash
mysql -u bitcoin_mining_master -pFzFbWmwMptnN3ABE bitcoin_mining_master < cloud-database-schema.sql
```

### 方案三：使用云端数据库（临时方案）

如果本地 MySQL 配置有困难，可以暂时使用云端数据库：

修改 `.env` 文件：
```bash
# 数据库配置 - 云端 MySQL
DB_HOST=47.79.232.189
DB_USER=bitcoin_mining_master
DB_PASS=FzFbWmwMptnN3ABE
DB_NAME=bitcoin_mining_master
DB_PORT=3306

# Redis 配置 - 云端 Redis  
REDIS_HOST=47.79.232.189
REDIS_PORT=6379
REDIS_PASSWORD=3hu8fds3y
```

## 验证配置

配置完成后，运行以下命令验证：

### 测试 MySQL 连接
```bash
node test_mysql_only.js
```

### 测试 MySQL 和 Redis
```bash
node test_db_connection.js
```

### 启动服务
```bash
npm run dev
```

## Redis 配置

本地 Redis 已运行，配置正确：
- ✅ 主机: 127.0.0.1
- ✅ 端口: 6379
- ✅ 密码: 已在 .env 中配置

测试 Redis 连接：
```bash
redis-cli -a 3hu8fds3y ping
```

## 已创建的工具

| 文件 | 用途 |
|------|------|
| `create-mysql9-user.sql` | MySQL 9.x 用户创建 SQL |
| `setup-mysql9-complete.sh` | 一键配置脚本 |
| `cloud-database-schema.sql` | 完整数据库结构 |

## 下一步

选择一个方案执行后：

1. ✅ 验证数据库连接
2. ✅ 验证 Redis 连接
3. ✅ 启动 Node 服务
4. ✅ 测试 API 接口

## 快速命令

```bash
# 配置 MySQL（需要 root 密码）
./setup-mysql9-complete.sh

# 测试连接
node test_mysql_only.js

# 启动服务
npm run dev
```

---

**更新时间**: 2025-12-18  
**MySQL 版本**: 9.5.0  
**Node.js 版本**: (检查: `node --version`)
